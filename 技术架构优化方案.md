# äº¤æ˜“æ‰˜ç®¡ç³»ç»ŸæŠ€æœ¯æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **é¡¹ç›®åç§°**: Trading Custody System
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-12-19
- **è´Ÿè´£äºº**: æŠ€æœ¯å›¢é˜Ÿ

---

## ä¸€ã€é¡¹ç›®ç°çŠ¶åˆ†æ

### 1.1 é¡¹ç›®æ¦‚è¿°
Trading Custody System æ˜¯ä¸€ä¸ªåŸºäº React å’Œ Express çš„äº¤æ˜“ä¸æ‰˜ç®¡ç®¡ç†ç³»ç»Ÿï¼Œæä¾›èµ„é‡‘ç®¡ç†ã€æŒä»“ç®¡ç†å’Œç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€‚

### 1.2 æŠ€æœ¯æ ˆ
- **å‰ç«¯**: React 18 + Ant Design Mobile + React Router v6
- **åç«¯**: Express.js + SQLite + JWT
- **å·¥å…·**: Jest + Cypress + Docker

### 1.3 ä¸»è¦é—®é¢˜æ€»ç»“

#### ğŸ”´ ä¸¥é‡å®‰å…¨é—®é¢˜ï¼ˆP0ï¼‰
1. **å¯†ç æ˜æ–‡å­˜å‚¨** - ç”¨æˆ·å¯†ç æœªåŠ å¯†ç›´æ¥å­˜å‚¨
2. **JWT Token ä¸å®‰å…¨** - å­˜å‚¨åœ¨ localStorageï¼Œæ˜“å— XSS æ”»å‡»
3. **JWT Secret ç¡¬ç¼–ç ** - ä½¿ç”¨é»˜è®¤å¯†é’¥ 'your-secret-key'
4. **API æƒé™éªŒè¯ç¼ºå¤±** - æ•æ„Ÿæ¥å£æ— æƒé™æ§åˆ¶

#### ğŸŸ  æ¶æ„è®¾è®¡é—®é¢˜ï¼ˆP1ï¼‰
5. **server.js èŒè´£æ··ä¹±** - ä¸šåŠ¡é€»è¾‘ã€è·¯ç”±ã€æ•°æ®åº“åˆå§‹åŒ–æ··æ‚
6. **æ•°æ®åº“æ“ä½œå›è°ƒåœ°ç‹±** - ä½¿ç”¨ callback è€Œé async/await
7. **æ§åˆ¶å™¨åŒ…å«ä¸šåŠ¡é€»è¾‘** - è¿ååˆ†å±‚åŸåˆ™
8. **ç¼ºå°‘æ•°æ®åº“ç´¢å¼•** - æŸ¥è¯¢æ€§èƒ½ä½ä¸‹

#### ğŸŸ¡ ä»£ç è´¨é‡é—®é¢˜ï¼ˆP2ï¼‰
9. **ç»„ä»¶èŒè´£ä¸æ¸…** - å­˜åœ¨å†—ä½™ç»„ä»¶
10. **æ ·å¼ç®¡ç†æ··ä¹±** - å†…è”æ ·å¼å’Œ CSS ç±»æ··ç”¨
11. **API è°ƒç”¨æ— ç»Ÿä¸€å¤„ç†** - é”™è¯¯å¤„ç†é‡å¤
12. **ç¼ºå°‘æ•°æ®åº“è¿ç§»æœºåˆ¶** - æ— ç‰ˆæœ¬ç®¡ç†

#### ğŸŸ¢ å·¥ç¨‹åŒ–é—®é¢˜ï¼ˆP3ï¼‰
13. **ç¼ºå°‘ä»£ç è§„èŒƒ** - æ—  ESLint/Prettier é…ç½®
14. **æµ‹è¯•è¦†ç›–ç‡ä¸ºé›¶** - æ— å®é™…æµ‹è¯•ç”¨ä¾‹
15. **ä¾èµ–åŒ…å®‰å…¨æ¼æ´** - 20 ä¸ªæ¼æ´ï¼ˆ13 ä¸ªé«˜å±ï¼‰
16. **ç¼ºå°‘ç¯å¢ƒå˜é‡ç¤ºä¾‹** - æ—  .env.example
17. **CORS é…ç½®å®½æ¾** - å…è®¸æ‰€æœ‰æ¥æº
18. **å¤–éƒ¨ API æ— å®¹é”™** - ç¼ºå°‘è¶…æ—¶å’Œé‡è¯•
19. **ç¼ºå°‘æ€§èƒ½ä¼˜åŒ–** - æ— ä»£ç åˆ†å‰²
20. **Docker é…ç½®è¿‡æ—¶** - Node.js 16 å·²è¿‡æ—¶

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 2.1 å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

#### 2.1.0 å‰ç«¯ Token å­˜å‚¨å®‰å…¨æ”¹é€ 
**ç›®æ ‡**: é…åˆåç«¯ JWT æ”¹é€ ï¼Œå‰ç«¯ç§»é™¤ localStorage å­˜å‚¨ï¼Œä½¿ç”¨ HttpOnly Cookie

**å®æ–½æ­¥éª¤**:
```javascript
// 1. ç§»é™¤æ‰€æœ‰ localStorage ç›¸å…³ä»£ç 
// src/App.jsx - åˆ é™¤ä»¥ä¸‹ä»£ç 
localStorage.getItem('authToken');
localStorage.setItem('authToken', token);
localStorage.removeItem('authToken');

// 2. ä¿®æ”¹æ‰€æœ‰ API è°ƒç”¨ï¼Œæ·»åŠ  credentials
fetch(url, {
  credentials: 'include', // æºå¸¦ Cookie
  headers: {
    'Content-Type': 'application/json'
  }
});

// 3. åˆ›å»ºç»Ÿä¸€çš„ API å®¢æˆ·ç«¯
// src/api/apiClient.js
class ApiClient {
  async request(endpoint, options = {}) {
    const config = {
      ...options,
      credentials: 'include', // è‡ªåŠ¨æºå¸¦ Cookie
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    };
    
    const response = await fetch(`${this.baseURL}${endpoint}`, config);
    
    if (!response.ok) {
      const error = await response.json();
      throw new ApiError(response.status, error.message);
    }
    
    return response.json();
  }
}
```

**å½±å“èŒƒå›´**:
- `src/App.jsx` - ç§»é™¤ localStorage æ“ä½œ
- `src/components/Login.jsx` - ä¿®æ”¹ç™»å½•é€»è¾‘
- `src/api/*.js` - æ‰€æœ‰ API è°ƒç”¨æ·»åŠ  credentials
- `src/components/UserFundPosition.jsx` - ç§»é™¤ userId ä» localStorage è¯»å–

**éªŒæ”¶æ ‡å‡†**:
- [ ] å‰ç«¯ä»£ç ä¸­æ—  localStorage å­˜å‚¨ token
- [ ] æ‰€æœ‰ API è¯·æ±‚æºå¸¦ credentials: 'include'
- [ ] ç™»å½•å token å­˜å‚¨åœ¨ Cookie ä¸­
- [ ] å‰ç«¯æ— æ³•é€šè¿‡ JS è®¿é—® token

---

### 2.1 å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

#### 2.1.1 å¯†ç åŠ å¯†æ–¹æ¡ˆ
**ç›®æ ‡**: ä½¿ç”¨ bcrypt å¯¹ç”¨æˆ·å¯†ç è¿›è¡ŒåŠ å¯†å­˜å‚¨

**æŠ€æœ¯é€‰å‹**: bcrypt (æ¨è) æˆ– argon2

**å®æ–½æ­¥éª¤**:
```javascript
// 1. å®‰è£…ä¾èµ–
npm install bcrypt

// 2. åˆ›å»ºå¯†ç å·¥å…·ç±» server/utils/passwordHelper.js
const bcrypt = require('bcrypt');
const SALT_ROUNDS = 10;

class PasswordHelper {
  static async hash(password) {
    return await bcrypt.hash(password, SALT_ROUNDS);
  }
  
  static async verify(password, hash) {
    return await bcrypt.compare(password, hash);
  }
}

// 3. ä¿®æ”¹ç”¨æˆ·æ³¨å†Œé€»è¾‘
const hashedPassword = await PasswordHelper.hash(password);
db.run("INSERT INTO users (name, email, password, role) VALUES (?, ?, ?, ?)", 
  [name, email, hashedPassword, role]);

// 4. ä¿®æ”¹ç™»å½•éªŒè¯é€»è¾‘
const user = await db.get("SELECT * FROM users WHERE email = ?", [email]);
const isValid = await PasswordHelper.verify(password, user.password);

// 5. æ•°æ®è¿ç§»è„šæœ¬ - åŠ å¯†ç°æœ‰å¯†ç 
// åˆ›å»º server/migrations/001_encrypt_passwords.js
```

**å½±å“èŒƒå›´**:
- `server/controllers/userController.js` - login, register, updatePassword
- `server/services/userService.js`
- æ•°æ®åº“ users è¡¨

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ–°ç”¨æˆ·æ³¨å†Œå¯†ç å·²åŠ å¯†
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ä¿®æ”¹å¯†ç åŠŸèƒ½æ­£å¸¸
- [ ] ç°æœ‰ç”¨æˆ·å¯†ç å·²è¿ç§»åŠ å¯†

---

#### 2.1.2 JWT å®‰å…¨æ”¹é€ æ–¹æ¡ˆ
**ç›®æ ‡**: ä½¿ç”¨ HttpOnly Cookie å­˜å‚¨ tokenï¼Œæ·»åŠ åˆ·æ–°æœºåˆ¶

**æŠ€æœ¯é€‰å‹**: cookie-parser + JWT refresh token

**å®æ–½æ­¥éª¤**:
```javascript
// 1. å®‰è£…ä¾èµ–
npm install cookie-parser

// 2. é…ç½®ç¯å¢ƒå˜é‡ .env
JWT_ACCESS_SECRET=ç”Ÿæˆçš„å¼ºéšæœºå¯†é’¥
JWT_REFRESH_SECRET=ç”Ÿæˆçš„å¼ºéšæœºå¯†é’¥
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

// 3. åˆ›å»º JWT å·¥å…·ç±» server/utils/jwtHelper.js
class JwtHelper {
  static generateAccessToken(payload) {
    return jwt.sign(payload, process.env.JWT_ACCESS_SECRET, {
      expiresIn: process.env.JWT_ACCESS_EXPIRES_IN
    });
  }
  
  static generateRefreshToken(payload) {
    return jwt.sign(payload, process.env.JWT_REFRESH_SECRET, {
      expiresIn: process.env.JWT_REFRESH_EXPIRES_IN
    });
  }
  
  static verifyAccessToken(token) {
    return jwt.verify(token, process.env.JWT_ACCESS_SECRET);
  }
  
  static verifyRefreshToken(token) {
    return jwt.verify(token, process.env.JWT_REFRESH_SECRET);
  }
}

// 4. ä¿®æ”¹ç™»å½•æ¥å£è¿”å› Cookie
res.cookie('accessToken', accessToken, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 15 * 60 * 1000 // 15åˆ†é’Ÿ
});

res.cookie('refreshToken', refreshToken, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000 // 7å¤©
});

// 5. åˆ›å»º token åˆ·æ–°æ¥å£
POST /api/auth/refresh

// 6. ä¿®æ”¹å‰ç«¯ API è°ƒç”¨
fetch(url, {
  credentials: 'include' // æºå¸¦ Cookie
});

// 7. æ·»åŠ  CSRF ä¿æŠ¤
npm install csurf
```

**å½±å“èŒƒå›´**:
- `server/server.js` - æ·»åŠ  cookie-parser ä¸­é—´ä»¶
- `server/controllers/userController.js` - login, refresh
- `server/middleware/authMiddleware.js` - ä» Cookie è¯»å– token
- `src/api/*.js` - æ‰€æœ‰ API è°ƒç”¨æ·»åŠ  credentials
- `src/App.jsx` - ç§»é™¤ localStorage ç›¸å…³ä»£ç 

**éªŒæ”¶æ ‡å‡†**:
- [ ] Token å­˜å‚¨åœ¨ HttpOnly Cookie ä¸­
- [ ] Token åˆ·æ–°æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯æ— æ³•é€šè¿‡ JS è®¿é—® token
- [ ] CSRF ä¿æŠ¤å·²å¯ç”¨

---

#### 2.1.3 API æƒé™æ§åˆ¶æ–¹æ¡ˆ
**ç›®æ ‡**: ä¸ºæ‰€æœ‰æ•æ„Ÿæ¥å£æ·»åŠ è®¤è¯å’Œæƒé™éªŒè¯

**å®æ–½æ­¥éª¤**:
```javascript
// 1. å¢å¼ºè®¤è¯ä¸­é—´ä»¶ server/middleware/authMiddleware.js
const authenticate = async (req, res, next) => {
  try {
    const token = req.cookies.accessToken;
    if (!token) {
      return res.status(401).json({ error: 'æœªæˆæƒè®¿é—®' });
    }
    
    const decoded = JwtHelper.verifyAccessToken(token);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Token æ— æ•ˆæˆ–å·²è¿‡æœŸ' });
  }
};

// 2. åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
const authorize = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
    }
    next();
  };
};

// 3. åº”ç”¨åˆ°è·¯ç”±
app.get('/api/users', authenticate, authorize('admin'), userController.getAllUsers);
app.delete('/api/users/:id', authenticate, authorize('admin'), userController.deleteUser);
app.get('/api/funds/:userId', authenticate, fundController.getFundBalance);

// 4. æ·»åŠ èµ„æºæ‰€æœ‰æƒéªŒè¯
const checkResourceOwnership = (req, res, next) => {
  const requestedUserId = parseInt(req.params.userId);
  const currentUserId = req.user.userId;
  const isAdmin = req.user.role === 'admin';
  
  if (!isAdmin && requestedUserId !== currentUserId) {
    return res.status(403).json({ error: 'æ— æƒè®¿é—®ä»–äººèµ„æº' });
  }
  next();
};
```

**å½±å“èŒƒå›´**:
- `server/middleware/authMiddleware.js`
- æ‰€æœ‰ controller æ–‡ä»¶
- `server/server.js` - è·¯ç”±é…ç½®

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£éœ€è¦è®¤è¯
- [ ] ç®¡ç†å‘˜æ¥å£éœ€è¦ admin è§’è‰²
- [ ] ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº
- [ ] æœªæˆæƒè®¿é—®è¿”å› 401/403

---

### 2.2 å‰ç«¯æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

#### 2.2.1 ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
**ç›®æ ‡**: åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤ºæœºåˆ¶

**æŠ€æœ¯é€‰å‹**: è‡ªå®šä¹‰ ApiError ç±» + Toast ç»Ÿä¸€æç¤º

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»ºé”™è¯¯ç±» src/utils/errorHandler.js
export class ApiError extends Error {
  constructor(status, message, data) {
    super(message);
    this.status = status;
    this.data = data;
    this.name = 'ApiError';
  }
}

export const ERROR_MESSAGES = {
  401: 'æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•',
  403: 'æƒé™ä¸è¶³',
  404: 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
  500: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
  NETWORK_ERROR: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
};

export const handleError = (error) => {
  if (error instanceof ApiError) {
    const message = ERROR_MESSAGES[error.status] || error.message;
    Toast.show({
      icon: 'fail',
      content: message
    });
    
    // 401 è·³è½¬åˆ°ç™»å½•é¡µ
    if (error.status === 401) {
      window.location.href = '/login';
    }
  } else {
    Toast.show({
      icon: 'fail',
      content: ERROR_MESSAGES.NETWORK_ERROR
    });
  }
  
  console.error('Error:', error);
};

// 2. åœ¨ ApiClient ä¸­ä½¿ç”¨
class ApiClient {
  async request(endpoint, options = {}) {
    try {
      const response = await fetch(url, config);
      
      if (!response.ok) {
        const error = await response.json();
        throw new ApiError(response.status, error.message, error);
      }
      
      return response.json();
    } catch (error) {
      if (error instanceof ApiError) throw error;
      throw new ApiError(0, ERROR_MESSAGES.NETWORK_ERROR, error);
    }
  }
}

// 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
try {
  await apiClient.post('/api/login', { username, password });
} catch (error) {
  handleError(error); // ç»Ÿä¸€å¤„ç†
}
```

**å½±å“èŒƒå›´**:
- `src/utils/errorHandler.js` - æ–°å»º
- `src/api/apiClient.js` - é›†æˆé”™è¯¯å¤„ç†
- æ‰€æœ‰ç»„ä»¶ - ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

**éªŒæ”¶æ ‡å‡†**:
- [ ] ApiError ç±»å·²åˆ›å»º
- [ ] æ‰€æœ‰ API é”™è¯¯ç»Ÿä¸€å¤„ç†
- [ ] é”™è¯¯æç¤ºä½¿ç”¨ Toast è€Œé alert
- [ ] 401 é”™è¯¯è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

---

#### 2.2.2 AuthContext çŠ¶æ€ç®¡ç†
**ç›®æ ‡**: åˆ›å»ºç»Ÿä¸€çš„è®¤è¯ä¸Šä¸‹æ–‡ï¼Œç®¡ç†ç”¨æˆ·çŠ¶æ€

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»º AuthContext src/contexts/AuthContext.jsx
import React, { createContext, useContext, useState, useEffect } from 'react';
import apiClient from '../api/apiClient';

const AuthContext = createContext(null);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    checkAuth();
  }, []);
  
  const checkAuth = async () => {
    try {
      const userData = await apiClient.get('/api/auth/me');
      setUser(userData);
    } catch (error) {
      setUser(null);
    } finally {
      setLoading(false);
    }
  };
  
  const login = async (username, password) => {
    const data = await apiClient.post('/api/auth/login', { username, password });
    setUser(data.user);
    return data;
  };
  
  const logout = async () => {
    await apiClient.post('/api/auth/logout');
    setUser(null);
  };
  
  return (
    <AuthContext.Provider value={{ user, loading, login, logout, checkAuth }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};

// 2. åœ¨ App.jsx ä¸­ä½¿ç”¨
function App() {
  return (
    <Router>
      <AuthProvider>
        <AppContent />
      </AuthProvider>
    </Router>
  );
}

// 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function Login() {
  const { login } = useAuth();
  
  const handleLogin = async () => {
    try {
      await login(username, password);
      navigate('/');
    } catch (error) {
      handleError(error);
    }
  };
}
```

**å½±å“èŒƒå›´**:
- `src/contexts/AuthContext.jsx` - æ–°å»º
- `src/App.jsx` - é›†æˆ AuthProviderï¼Œç§»é™¤åˆ†æ•£çš„çŠ¶æ€
- `src/components/Login.jsx` - ä½¿ç”¨ useAuth
- æ‰€æœ‰éœ€è¦è®¤è¯çš„ç»„ä»¶ - ä½¿ç”¨ useAuth

**éªŒæ”¶æ ‡å‡†**:
- [ ] AuthContext å·²åˆ›å»º
- [ ] App.jsx ä¸­åˆ†æ•£çš„è®¤è¯çŠ¶æ€å·²ç§»é™¤
- [ ] æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ useAuth è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] è®¤è¯çŠ¶æ€ç»Ÿä¸€ç®¡ç†

---

#### 2.2.3 è·¯ç”±å®ˆå«ä¼˜åŒ–
**ç›®æ ‡**: ä½¿ç”¨è·¯ç”±é…ç½®å’Œå…ƒæ•°æ®ç®€åŒ–æƒé™åˆ¤æ–­

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»ºè·¯ç”±é…ç½® src/routes/index.jsx
const routes = [
  {
    path: '/login',
    element: <Login />,
    meta: { requiresAuth: false }
  },
  {
    path: '/',
    element: <AdminDashboard />,
    meta: { requiresAuth: true, requiresAdmin: true }
  },
  {
    path: '/user-fund-position',
    element: <UserFundPosition />,
    meta: { requiresAuth: true }
  },
  {
    path: '/user-management',
    element: <UserManagement />,
    meta: { requiresAuth: true, requiresAdmin: true }
  }
];

// 2. ä¼˜åŒ– ProtectedRoute
const ProtectedRoute = ({ children, meta = {} }) => {
  const { user, loading } = useAuth();
  const location = useLocation();
  
  if (loading) {
    return <Loading />;
  }
  
  if (meta.requiresAuth && !user) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }
  
  if (meta.requiresAdmin && user?.role !== 'admin') {
    return <Navigate to="/user-fund-position" replace />;
  }
  
  return children;
};

// 3. ä½¿ç”¨è·¯ç”±é…ç½®
function AppRoutes() {
  return (
    <Routes>
      {routes.map(route => (
        <Route
          key={route.path}
          path={route.path}
          element={
            <ProtectedRoute meta={route.meta}>
              {route.element}
            </ProtectedRoute>
          }
        />
      ))}
    </Routes>
  );
}
```

**å½±å“èŒƒå›´**:
- `src/routes/index.jsx` - æ–°å»ºè·¯ç”±é…ç½®
- `src/App.jsx` - ç®€åŒ– ProtectedRoute é€»è¾‘
- è·¯ç”±å®šä¹‰ - ä½¿ç”¨é…ç½®åŒ–æ–¹å¼

**éªŒæ”¶æ ‡å‡†**:
- [ ] è·¯ç”±é…ç½®å·²åˆ›å»º
- [ ] ProtectedRoute ä¸å†è¯»å– localStorage
- [ ] æƒé™åˆ¤æ–­é€»è¾‘ç»Ÿä¸€
- [ ] è·¯ç”±é…ç½®æ˜“äºç»´æŠ¤

---

#### 2.2.4 API é…ç½®ç»Ÿä¸€ç®¡ç†
**ç›®æ ‡**: ç»Ÿä¸€ç®¡ç† API åŸºç¡€ URL å’Œé…ç½®

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»ºé…ç½®æ–‡ä»¶ src/config/api.js
export const API_CONFIG = {
  BASE_URL: process.env.REACT_APP_API_BASE_URL || 'http://localhost:3001',
  TIMEOUT: 30000,
  RETRY_TIMES: 3
};

// 2. åˆ›å»ºç»Ÿä¸€çš„ API å®¢æˆ·ç«¯ src/api/apiClient.js
import { API_CONFIG } from '../config/api';

class ApiClient {
  constructor() {
    this.baseURL = API_CONFIG.BASE_URL;
    this.timeout = API_CONFIG.TIMEOUT;
  }
  
  // ... request æ–¹æ³•å®ç°
}

export default new ApiClient();

// 3. æ‰€æœ‰ API æ–‡ä»¶ç»Ÿä¸€å¼•ç”¨
import apiClient from './apiClient';

export const getAllUsers = () => apiClient.get('/api/users');
export const createUser = (data) => apiClient.post('/api/users', data);
```

**å½±å“èŒƒå›´**:
- `src/config/api.js` - æ–°å»º
- `src/api/apiClient.js` - æ–°å»º
- `src/api/*.js` - é‡æ„ä¸ºä½¿ç”¨ apiClient
- æ‰€æœ‰ç»„ä»¶ - ç§»é™¤ç›´æ¥çš„ fetch è°ƒç”¨

**éªŒæ”¶æ ‡å‡†**:
- [ ] API é…ç½®å·²ç»Ÿä¸€ç®¡ç†
- [ ] æ‰€æœ‰ API è°ƒç”¨ä½¿ç”¨ apiClient
- [ ] ç§»é™¤é‡å¤çš„ API_BASE_URL å®šä¹‰
- [ ] æ”¯æŒç¯å¢ƒå˜é‡é…ç½®

---

#### 2.2.5 ç»„ä»¶æ ·å¼ç®¡ç†è§„èŒƒ
**ç›®æ ‡**: ç»Ÿä¸€æ ·å¼ç®¡ç†ï¼Œç§»é™¤å†…è”æ ·å¼

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»º CSS å˜é‡ src/styles/variables.css
:root {
  /* é¢œè‰² */
  --primary-color: #1890ff;
  --success-color: #52c41a;
  --error-color: #ff4d4f;
  --warning-color: #faad14;
  --bg-color: #f0f2f5;
  --text-color: #333;
  
  /* é—´è· */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* å­—ä½“ */
  --font-size-sm: 12px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 20px;
  
  /* åœ†è§’ */
  --border-radius-sm: 4px;
  --border-radius-md: 8px;
  --border-radius-lg: 12px;
}

// 2. é‡æ„ç»„ä»¶æ ·å¼ src/components/UserFundPosition.css
.fund-position-container {
  width: 100%;
  background-color: var(--bg-color);
  min-height: 100vh;
  padding: var(--spacing-sm);
}

.fund-position-title {
  text-align: center;
  margin-bottom: var(--spacing-md);
  color: var(--primary-color);
  font-size: var(--font-size-xl);
  font-weight: 600;
  padding-top: var(--spacing-xs);
}

.fund-card {
  margin-bottom: var(--spacing-md);
  border-radius: var(--border-radius-md);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  background-color: #ffffff;
  border: none;
}

// 3. ç»„ä»¶ä¸­ä½¿ç”¨ CSS ç±»
<div className="fund-position-container">
  <div className="fund-position-title">æˆ‘çš„èµ„é‡‘ä¸æŒä»“</div>
  <Card className="fund-card">
    {/* ... */}
  </Card>
</div>
```

**å½±å“èŒƒå›´**:
- `src/styles/variables.css` - æ–°å»º
- `src/components/*.css` - é‡æ„æ ·å¼
- `src/components/*.jsx` - ç§»é™¤å†…è”æ ·å¼

**éªŒæ”¶æ ‡å‡†**:
- [ ] CSS å˜é‡å·²å®šä¹‰
- [ ] æ‰€æœ‰å†…è”æ ·å¼å·²ç§»é™¤
- [ ] ç»„ä»¶ä½¿ç”¨ CSS ç±»
- [ ] æ ·å¼å¯å¤ç”¨å’Œç»´æŠ¤

---

#### 2.2.6 å¸¸é‡ç®¡ç†
**ç›®æ ‡**: æ¶ˆé™¤é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç å­—ç¬¦ä¸²

**å®æ–½æ­¥éª¤**:
```javascript
// 1. åˆ›å»ºå¸¸é‡æ–‡ä»¶ src/constants/index.js
export const ROLES = {
  ADMIN: 'admin',
  USER: 'user'
};

export const KEYS = {
  ENTER: 'Enter',
  ESCAPE: 'Escape'
};

export const LIMITS = {
  FUND_LOGS: 5,
  POSITIONS_PER_PAGE: 10,
  TRADE_HISTORY_LIMIT: 20
};

export const ROUTES = {
  LOGIN: '/login',
  ADMIN_DASHBOARD: '/',
  USER_FUND_POSITION: '/user-fund-position',
  CHANGE_PASSWORD: '/change-password',
  USER_MANAGEMENT: '/user-management',
  FUND_MANAGEMENT: '/fund-management',
  POSITION_MANAGEMENT: '/position-management'
};

// 2. åœ¨ä»£ç ä¸­ä½¿ç”¨å¸¸é‡
import { ROLES, KEYS, LIMITS, ROUTES } from '../constants';

// æ›¿æ¢ç¡¬ç¼–ç 
if (user.role !== ROLES.ADMIN) {
  navigate(ROUTES.USER_FUND_POSITION);
}

if (e.key === KEYS.ENTER) {
  handleLogin();
}

const recentLogs = logs.slice(0, LIMITS.FUND_LOGS);
```

**å½±å“èŒƒå›´**:
- `src/constants/index.js` - æ–°å»º
- æ‰€æœ‰ç»„ä»¶ - æ›¿æ¢ç¡¬ç¼–ç 

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¸¸é‡æ–‡ä»¶å·²åˆ›å»º
- [ ] æ‰€æœ‰é­”æ³•æ•°å­—å·²æ›¿æ¢
- [ ] æ‰€æœ‰ç¡¬ç¼–ç å­—ç¬¦ä¸²å·²æ›¿æ¢
- [ ] ä½¿ç”¨ === è€Œé ==

---

### 2.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

#### 2.3.1 ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
**ç›®æ ‡**: å‡å°‘é¦–å±åŠ è½½æ—¶é—´ï¼ŒæŒ‰éœ€åŠ è½½ç»„ä»¶

**å®æ–½æ­¥éª¤**:
```javascript
// 1. ä½¿ç”¨ React.lazy æ‡’åŠ è½½ç»„ä»¶
import React, { Suspense, lazy } from 'react';

const Login = lazy(() => import('./components/Login'));
const AdminDashboard = lazy(() => import('./components/AdminDashboard'));
const UserManagement = lazy(() => import('./components/UserManagement'));
const FundManagement = lazy(() => import('./components/FundManagement'));
const PositionManagement = lazy(() => import('./components/PositionManagement'));
const UserFundPosition = lazy(() => import('./components/UserFundPosition'));
const ChangePassword = lazy(() => import('./components/ChangePassword'));

// 2. åˆ›å»ºåŠ è½½ä¸­ç»„ä»¶
const LoadingFallback = () => (
  <div className="loading-container">
    <div className="spinner" />
    <p>åŠ è½½ä¸­...</p>
  </div>
);

// 3. ä½¿ç”¨ Suspense åŒ…è£¹è·¯ç”±
function App() {
  return (
    <Router>
      <AuthProvider>
        <Suspense fallback={<LoadingFallback />}>
          <Routes>
            {/* ... */}
          </Routes>
        </Suspense>
      </AuthProvider>
    </Router>
  );
}
```

**å½±å“èŒƒå›´**:
- `src/App.jsx` - æ”¹ä¸ºæ‡’åŠ è½½
- æ‰€æœ‰é¡µé¢ç»„ä»¶ - æŒ‰éœ€åŠ è½½

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰é¡µé¢ç»„ä»¶ä½¿ç”¨æ‡’åŠ è½½
- [ ] é¦–å±åŠ è½½æ—¶é—´å‡å°‘ 30% ä»¥ä¸Š
- [ ] åˆå§‹åŒ…ä½“ç§¯å‡å°‘
- [ ] åŠ è½½ä¸­çŠ¶æ€å‹å¥½

---

#### 2.3.2 React æ€§èƒ½ä¼˜åŒ–
**ç›®æ ‡**: ä½¿ç”¨ React.memoã€useCallbackã€useMemo ä¼˜åŒ–æ¸²æŸ“

**å®æ–½æ­¥éª¤**:
```javascript
// 1. å¯¹çº¯å±•ç¤ºç»„ä»¶ä½¿ç”¨ React.memo
const AdminDashboard = React.memo(({ username, onLogout }) => {
  // ...
});

// 2. ä½¿ç”¨ useCallback ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°
const handleLogin = useCallback((token, role, username, userId) => {
  // ...
}, [navigate]);

const handleLogout = useCallback(() => {
  // ...
}, [navigate]);

// 3. ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœï¼ˆä»…åœ¨æ•°æ®é‡å¤§æ—¶ï¼‰
const totalPnL = useMemo(() => {
  if (consolidatedPositions.length > 100) {
    return consolidatedPositions.reduce((sum, pos) => sum + pos.totalPnL, 0);
  }
  // æ•°æ®é‡å°æ—¶ç›´æ¥è®¡ç®—
  return consolidatedPositions.reduce((sum, pos) => sum + pos.totalPnL, 0);
}, [consolidatedPositions]);

// 4. æ·»åŠ è¯·æ±‚å–æ¶ˆæœºåˆ¶
useEffect(() => {
  const abortController = new AbortController();
  
  const fetchData = async () => {
    try {
      await apiClient.get('/api/users', {
        signal: abortController.signal
      });
    } catch (error) {
      if (error.name !== 'AbortError') {
        handleError(error);
      }
    }
  };
  
  fetchData();
  
  return () => {
    abortController.abort();
  };
}, []);
```

**å½±å“èŒƒå›´**:
- æ‰€æœ‰ç»„ä»¶ - æ·»åŠ æ€§èƒ½ä¼˜åŒ–
- API è°ƒç”¨ - æ·»åŠ å–æ¶ˆæœºåˆ¶

**éªŒæ”¶æ ‡å‡†**:
- [ ] çº¯å±•ç¤ºç»„ä»¶ä½¿ç”¨ React.memo
- [ ] äº‹ä»¶å¤„ç†å‡½æ•°ä½¿ç”¨ useCallback
- [ ] å¤æ‚è®¡ç®—ä½¿ç”¨ useMemo
- [ ] API è¯·æ±‚æ”¯æŒå–æ¶ˆ
- [ ] ç»„ä»¶å¸è½½æ—¶æ¸…ç†å‰¯ä½œç”¨

---

### 2.4 æ¶æ„é‡æ„æ–¹æ¡ˆ

#### 2.2.1 åç«¯åˆ†å±‚æ¶æ„é‡æ„
**ç›®æ ‡**: å®ç°æ¸…æ™°çš„ä¸‰å±‚æ¶æ„ï¼ˆController - Service - DAOï¼‰

**æ–°ç›®å½•ç»“æ„**:
```
server/
â”œâ”€â”€ server.js                 # åº”ç”¨å…¥å£
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ database.js          # æ•°æ®åº“é…ç½®å’Œè¿æ¥
â”‚   â”œâ”€â”€ routes.js            # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ env.js               # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ controllers/             # æ§åˆ¶å™¨å±‚ï¼ˆå¤„ç† HTTP è¯·æ±‚ï¼‰
â”‚   â”œâ”€â”€ authController.js
â”‚   â”œâ”€â”€ userController.js
â”‚   â”œâ”€â”€ fundController.js
â”‚   â””â”€â”€ positionController.js
â”œâ”€â”€ services/                # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ authService.js
â”‚   â”œâ”€â”€ userService.js
â”‚   â”œâ”€â”€ fundService.js
â”‚   â”œâ”€â”€ positionService.js
â”‚   â””â”€â”€ priceService.js      # ä» server.js è¿ç§»
â”œâ”€â”€ dao/                     # æ•°æ®è®¿é—®å±‚ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
â”‚   â”œâ”€â”€ userDao.js
â”‚   â”œâ”€â”€ fundDao.js
â”‚   â”œâ”€â”€ positionDao.js
â”‚   â””â”€â”€ priceDao.js
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ authMiddleware.js
â”‚   â”œâ”€â”€ errorMiddleware.js
â”‚   â”œâ”€â”€ logMiddleware.js
â”‚   â””â”€â”€ validationMiddleware.js  # æ–°å¢
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ database.js          # æ•°æ®åº“å·¥å…·ï¼ˆPromise å°è£…ï¼‰
â”‚   â”œâ”€â”€ jwtHelper.js         # JWT å·¥å…·
â”‚   â”œâ”€â”€ passwordHelper.js    # å¯†ç å·¥å…·
â”‚   â”œâ”€â”€ logger.js
â”‚   â””â”€â”€ validator.js         # æ–°å¢
â”œâ”€â”€ migrations/              # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ 001_create_tables.sql
â”‚   â”œâ”€â”€ 002_add_indexes.sql
â”‚   â””â”€â”€ 003_encrypt_passwords.js
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â”œâ”€â”€ integration/
    â””â”€â”€ e2e/
```

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“å·¥å…·ç±»**
```javascript
// server/utils/database.js
const sqlite3 = require('sqlite3').verbose();
const { promisify } = require('util');

class Database {
  constructor(dbPath) {
    this.db = new sqlite3.Database(dbPath);
    this.run = promisify(this.db.run.bind(this.db));
    this.get = promisify(this.db.get.bind(this.db));
    this.all = promisify(this.db.all.bind(this.db));
  }
  
  async transaction(callback) {
    await this.run('BEGIN TRANSACTION');
    try {
      await callback();
      await this.run('COMMIT');
    } catch (error) {
      await this.run('ROLLBACK');
      throw error;
    }
  }
}

module.exports = new Database(process.env.DATABASE_PATH);
```

**æ­¥éª¤ 2: åˆ›å»º DAO å±‚**
```javascript
// server/dao/userDao.js
const db = require('../utils/database');

class UserDao {
  async findByEmail(email) {
    return await db.get('SELECT * FROM users WHERE email = ?', [email]);
  }
  
  async findById(id) {
    return await db.get('SELECT * FROM users WHERE id = ?', [id]);
  }
  
  async create(userData) {
    const { name, email, password, role } = userData;
    const result = await db.run(
      'INSERT INTO users (name, email, password, role) VALUES (?, ?, ?, ?)',
      [name, email, password, role]
    );
    return result.lastID;
  }
  
  async update(id, userData) {
    const { name, email, role } = userData;
    await db.run(
      'UPDATE users SET name = ?, email = ?, role = ? WHERE id = ?',
      [name, email, role, id]
    );
  }
  
  async updatePassword(id, hashedPassword) {
    await db.run(
      'UPDATE users SET password = ? WHERE id = ?',
      [hashedPassword, id]
    );
  }
  
  async delete(id) {
    await db.run('DELETE FROM users WHERE id = ?', [id]);
  }
  
  async findAll() {
    return await db.all('SELECT id, name, email, role FROM users');
  }
}

module.exports = new UserDao();
```

**æ­¥éª¤ 3: é‡æ„ Service å±‚**
```javascript
// server/services/authService.js
const userDao = require('../dao/userDao');
const PasswordHelper = require('../utils/passwordHelper');
const JwtHelper = require('../utils/jwtHelper');
const AppError = require('../utils/AppError');

class AuthService {
  async login(email, password) {
    const user = await userDao.findByEmail(email);
    if (!user) {
      throw new AppError('ç”¨æˆ·ä¸å­˜åœ¨', 'USER_NOT_FOUND', 404);
    }
    
    const isValid = await PasswordHelper.verify(password, user.password);
    if (!isValid) {
      throw new AppError('å¯†ç é”™è¯¯', 'INVALID_PASSWORD', 401);
    }
    
    const payload = {
      userId: user.id,
      username: user.name,
      role: user.role
    };
    
    const accessToken = JwtHelper.generateAccessToken(payload);
    const refreshToken = JwtHelper.generateRefreshToken(payload);
    
    return { accessToken, refreshToken, user };
  }
  
  async register(userData) {
    const existingUser = await userDao.findByEmail(userData.email);
    if (existingUser) {
      throw new AppError('é‚®ç®±å·²è¢«æ³¨å†Œ', 'EMAIL_EXISTS', 400);
    }
    
    const hashedPassword = await PasswordHelper.hash(userData.password);
    const userId = await userDao.create({
      ...userData,
      password: hashedPassword
    });
    
    return userId;
  }
  
  async refreshToken(refreshToken) {
    try {
      const decoded = JwtHelper.verifyRefreshToken(refreshToken);
      const payload = {
        userId: decoded.userId,
        username: decoded.username,
        role: decoded.role
      };
      
      const newAccessToken = JwtHelper.generateAccessToken(payload);
      return newAccessToken;
    } catch (error) {
      throw new AppError('Refresh token æ— æ•ˆ', 'INVALID_REFRESH_TOKEN', 401);
    }
  }
}

module.exports = new AuthService();
```

**æ­¥éª¤ 4: ç®€åŒ– Controller å±‚**
```javascript
// server/controllers/authController.js
const authService = require('../services/authService');

class AuthController {
  async login(req, res, next) {
    try {
      const { email, password } = req.body;
      const { accessToken, refreshToken, user } = await authService.login(email, password);
      
      // è®¾ç½® HttpOnly Cookie
      res.cookie('accessToken', accessToken, {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
        maxAge: 15 * 60 * 1000
      });
      
      res.cookie('refreshToken', refreshToken, {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
        maxAge: 7 * 24 * 60 * 60 * 1000
      });
      
      res.json({
        success: true,
        user: {
          id: user.id,
          name: user.name,
          email: user.email,
          role: user.role
        }
      });
    } catch (error) {
      next(error);
    }
  }
  
  async register(req, res, next) {
    try {
      const userId = await authService.register(req.body);
      res.status(201).json({
        success: true,
        userId
      });
    } catch (error) {
      next(error);
    }
  }
  
  async refresh(req, res, next) {
    try {
      const refreshToken = req.cookies.refreshToken;
      const newAccessToken = await authService.refreshToken(refreshToken);
      
      res.cookie('accessToken', newAccessToken, {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
        maxAge: 15 * 60 * 1000
      });
      
      res.json({ success: true });
    } catch (error) {
      next(error);
    }
  }
  
  async logout(req, res) {
    res.clearCookie('accessToken');
    res.clearCookie('refreshToken');
    res.json({ success: true });
  }
}

module.exports = new AuthController();
```

**æ­¥éª¤ 5: é‡æ„ server.js**
```javascript
// server/server.js
const express = require('express');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const config = require('./config/env');
const routes = require('./config/routes');
const errorHandler = require('./middleware/errorMiddleware');
const logMiddleware = require('./middleware/logMiddleware');
const logger = require('./utils/logger');

const app = express();

// ä¸­é—´ä»¶
app.use(cors(config.cors));
app.use(express.json());
app.use(cookieParser());
app.use(logMiddleware);

// è·¯ç”±
app.use('/api', routes);

// é”™è¯¯å¤„ç†
app.use(errorHandler);

// å¯åŠ¨æœåŠ¡å™¨
app.listen(config.port, () => {
  logger.info(`Server running on http://localhost:${config.port}`);
});

module.exports = app;
```

**å½±å“èŒƒå›´**:
- æ•´ä¸ª server ç›®å½•ç»“æ„
- æ‰€æœ‰åç«¯æ–‡ä»¶éœ€è¦é‡æ„

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä¸‰å±‚æ¶æ„æ¸…æ™°åˆ†ç¦»
- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ async/await
- [ ] Controller åªè´Ÿè´£è¯·æ±‚å“åº”
- [ ] Service åŒ…å«æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
- [ ] DAO å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- [ ] æ‰€æœ‰æ¥å£åŠŸèƒ½æ­£å¸¸

---

#### 2.2.2 æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ
**ç›®æ ‡**: æ·»åŠ ç´¢å¼•ã€å¤–é”®çº¦æŸï¼Œå®ç°è¿ç§»æœºåˆ¶

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: åˆ›å»ºè¿ç§»å·¥å…·**
```javascript
// server/migrations/migrator.js
const fs = require('fs');
const path = require('path');
const db = require('../utils/database');

class Migrator {
  async init() {
    await db.run(`
      CREATE TABLE IF NOT EXISTS migrations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        executed_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
  }
  
  async getExecutedMigrations() {
    const rows = await db.all('SELECT name FROM migrations ORDER BY id');
    return rows.map(row => row.name);
  }
  
  async executeMigration(name, sql) {
    await db.transaction(async () => {
      await db.run(sql);
      await db.run('INSERT INTO migrations (name) VALUES (?)', [name]);
    });
  }
  
  async migrate() {
    await this.init();
    const executed = await this.getExecutedMigrations();
    const migrationFiles = fs.readdirSync(__dirname)
      .filter(f => f.endsWith('.sql'))
      .sort();
    
    for (const file of migrationFiles) {
      if (!executed.includes(file)) {
        const sql = fs.readFileSync(path.join(__dirname, file), 'utf8');
        await this.executeMigration(file, sql);
        console.log(`Executed migration: ${file}`);
      }
    }
  }
}

module.exports = new Migrator();
```

**æ­¥éª¤ 2: åˆ›å»ºç´¢å¼•è¿ç§»è„šæœ¬**
```sql
-- server/migrations/002_add_indexes.sql

-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);

-- èµ„é‡‘è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_funds_user_id ON funds(user_id);

-- èµ„é‡‘æ—¥å¿—è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_fund_logs_user_id ON fund_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_fund_logs_timestamp ON fund_logs(timestamp);
CREATE INDEX IF NOT EXISTS idx_fund_logs_type ON fund_logs(type);

-- æŒä»“è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_positions_user_id ON positions(user_id);
CREATE INDEX IF NOT EXISTS idx_positions_code ON positions(code);
CREATE INDEX IF NOT EXISTS idx_positions_asset_type ON positions(asset_type);
CREATE INDEX IF NOT EXISTS idx_positions_timestamp ON positions(timestamp);
CREATE INDEX IF NOT EXISTS idx_positions_user_code ON positions(user_id, code, asset_type);

-- ä»·æ ¼æ•°æ®è¡¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_price_data_code_type ON price_data(code, asset_type);
CREATE INDEX IF NOT EXISTS idx_price_data_timestamp ON price_data(timestamp);
```

**æ­¥éª¤ 3: ä¼˜åŒ–è¡¨ç»“æ„**
```sql
-- server/migrations/003_optimize_schema.sql

-- æ·»åŠ å­—æ®µçº¦æŸ
ALTER TABLE users ADD COLUMN created_at DATETIME DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE users ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP;

-- æ·»åŠ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° updated_at
CREATE TRIGGER IF NOT EXISTS update_users_timestamp 
AFTER UPDATE ON users
BEGIN
  UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- ä¼˜åŒ–å¤–é”®çº¦æŸï¼ˆSQLite éœ€è¦é‡å»ºè¡¨ï¼‰
-- æ³¨æ„ï¼šå®é™…æ‰§è¡Œæ—¶éœ€è¦å¤‡ä»½æ•°æ®åé‡å»ºè¡¨
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] è¿ç§»æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] æ‰€æœ‰ç´¢å¼•å·²åˆ›å»º
- [ ] æŸ¥è¯¢æ€§èƒ½æå‡ 50% ä»¥ä¸Š
- [ ] æ•°æ®å®Œæ•´æ€§çº¦æŸç”Ÿæ•ˆ

---

### 2.3 å‰ç«¯ä¼˜åŒ–æ–¹æ¡ˆ

#### 2.3.1 ç»„ä»¶é‡æ„æ–¹æ¡ˆ
**ç›®æ ‡**: ä¼˜åŒ–ç»„ä»¶ç»“æ„ï¼Œæå‡å¤ç”¨æ€§

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: ç§»é™¤å†—ä½™ç»„ä»¶**
```javascript
// åˆ é™¤ src/components/UserDashboard.jsx
// ä¿®æ”¹ src/App.jsx è·¯ç”±é…ç½®
<Route path="/user" element={<Navigate to="/user-fund-position" replace />} />
```

**æ­¥éª¤ 2: æŠ½å–å…¬å…±ç»„ä»¶**
```javascript
// src/components/common/NavigationCard.jsx
import React from 'react';
import { Card } from 'antd-mobile';
import { useNavigate } from 'react-router-dom';

const NavigationCard = ({ title, description, icon, path, color }) => {
  const navigate = useNavigate();
  
  return (
    <Card
      className="navigation-card"
      onClick={() => navigate(path)}
      style={{ borderLeft: `4px solid ${color}` }}
    >
      <div className="card-content">
        <div className="card-icon" style={{ color }}>{icon}</div>
        <div className="card-text">
          <h3>{title}</h3>
          <p>{description}</p>
        </div>
      </div>
    </Card>
  );
};

export default NavigationCard;
```

**æ­¥éª¤ 3: ç»Ÿä¸€æ ·å¼ç®¡ç†**
```css
/* src/styles/components.css */
.navigation-card {
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.navigation-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.card-content {
  display: flex;
  align-items: center;
  padding: 16px;
}

.card-icon {
  font-size: 32px;
  margin-right: 16px;
}

.card-text h3 {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
}

.card-text p {
  margin: 0;
  font-size: 14px;
  color: #666;
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å†—ä½™ç»„ä»¶å·²ç§»é™¤
- [ ] å…¬å…±ç»„ä»¶æŠ½å–å®Œæˆ
- [ ] æ ·å¼ç»Ÿä¸€ä½¿ç”¨ CSS ç±»
- [ ] ç»„ä»¶å¤ç”¨æ€§æå‡

---

#### 2.3.2 API è°ƒç”¨ä¼˜åŒ–æ–¹æ¡ˆ
**ç›®æ ‡**: ç»Ÿä¸€ API è°ƒç”¨å’Œé”™è¯¯å¤„ç†

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: åˆ›å»º API å®¢æˆ·ç«¯**
```javascript
// src/api/apiClient.js
class ApiError extends Error {
  constructor(status, message, data) {
    super(message);
    this.status = status;
    this.data = data;
  }
}

class ApiClient {
  constructor(baseURL) {
    this.baseURL = baseURL;
  }
  
  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`;
    const config = {
      ...options,
      credentials: 'include', // æºå¸¦ Cookie
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    };
    
    try {
      const response = await fetch(url, config);
      const data = await response.json();
      
      if (!response.ok) {
        throw new ApiError(response.status, data.error || 'è¯·æ±‚å¤±è´¥', data);
      }
      
      return data;
    } catch (error) {
      if (error instanceof ApiError) {
        throw error;
      }
      throw new ApiError(0, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', null);
    }
  }
  
  get(endpoint, options) {
    return this.request(endpoint, { ...options, method: 'GET' });
  }
  
  post(endpoint, data, options) {
    return this.request(endpoint, {
      ...options,
      method: 'POST',
      body: JSON.stringify(data)
    });
  }
  
  put(endpoint, data, options) {
    return this.request(endpoint, {
      ...options,
      method: 'PUT',
      body: JSON.stringify(data)
    });
  }
  
  delete(endpoint, options) {
    return this.request(endpoint, { ...options, method: 'DELETE' });
  }
}

const apiClient = new ApiClient(process.env.REACT_APP_API_BASE_URL || 'http://localhost:3001');

export default apiClient;
export { ApiError };
```

**æ­¥éª¤ 2: é‡æ„ API è°ƒç”¨**
```javascript
// src/api/authApi.js
import apiClient from './apiClient';

export const login = async (email, password) => {
  return await apiClient.post('/api/auth/login', { email, password });
};

export const logout = async () => {
  return await apiClient.post('/api/auth/logout');
};

export const refreshToken = async () => {
  return await apiClient.post('/api/auth/refresh');
};

// src/api/userApi.js
import apiClient from './apiClient';

export const getCurrentUser = async () => {
  return await apiClient.get('/api/users/me');
};

export const updatePassword = async (oldPassword, newPassword) => {
  return await apiClient.put('/api/users/password', { oldPassword, newPassword });
};

export const getAllUsers = async () => {
  return await apiClient.get('/api/users');
};
```

**æ­¥éª¤ 3: åˆ›å»ºé€šç”¨ API Hook**
```javascript
// src/hooks/useApi.js
import { useState, useCallback } from 'react';
import { ApiError } from '../api/apiClient';

const useApi = (apiFunc) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  const execute = useCallback(async (...args) => {
    setLoading(true);
    setError(null);
    
    try {
      const result = await apiFunc(...args);
      setData(result);
      return result;
    } catch (err) {
      if (err instanceof ApiError) {
        setError(err.message);
      } else {
        setError('æœªçŸ¥é”™è¯¯');
      }
      throw err;
    } finally {
      setLoading(false);
    }
  }, [apiFunc]);
  
  return { data, loading, error, execute };
};

export default useApi;
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] API å®¢æˆ·ç«¯ç»Ÿä¸€å°è£…
- [ ] é”™è¯¯å¤„ç†ç»Ÿä¸€ç®¡ç†
- [ ] æ‰€æœ‰ API è°ƒç”¨ä½¿ç”¨æ–°å®¢æˆ·ç«¯
- [ ] é€šç”¨ Hook æ­£å¸¸å·¥ä½œ

---

#### 2.3.3 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
**ç›®æ ‡**: å®ç°ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: è·¯ç”±çº§ä»£ç åˆ†å‰²**
```javascript
// src/App.jsx
import React, { Suspense, lazy } from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { SpinLoading } from 'antd-mobile';

// æ‡’åŠ è½½ç»„ä»¶
const Login = lazy(() => import('./components/Login'));
const AdminDashboard = lazy(() => import('./components/AdminDashboard'));
const UserManagement = lazy(() => import('./components/UserManagement'));
const FundManagement = lazy(() => import('./components/FundManagement'));
const PositionManagement = lazy(() => import('./components/PositionManagement'));
const UserFundPosition = lazy(() => import('./components/UserFundPosition'));
const ChangePassword = lazy(() => import('./components/ChangePassword'));

// åŠ è½½ä¸­ç»„ä»¶
const LoadingFallback = () => (
  <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
    <SpinLoading color="primary" />
  </div>
);

function App() {
  return (
    <Router>
      <Suspense fallback={<LoadingFallback />}>
        <Routes>
          <Route path="/login" element={<Login />} />
          <Route path="/admin" element={<ProtectedRoute><AdminDashboard /></ProtectedRoute>} />
          {/* å…¶ä»–è·¯ç”± */}
        </Routes>
      </Suspense>
    </Router>
  );
}
```

**æ­¥éª¤ 2: ç»„ä»¶çº§æ‡’åŠ è½½**
```javascript
// å¯¹å¤§å‹ç»„ä»¶ä½¿ç”¨æ‡’åŠ è½½
const HeavyChart = lazy(() => import('./components/HeavyChart'));

function Dashboard() {
  return (
    <div>
      <h1>Dashboard</h1>
      <Suspense fallback={<div>åŠ è½½å›¾è¡¨ä¸­...</div>}>
        <HeavyChart />
      </Suspense>
    </div>
  );
}
```

**æ­¥éª¤ 3: èµ„æºé¢„åŠ è½½**
```javascript
// src/utils/preload.js
export const preloadRoute = (routePath) => {
  const routeMap = {
    '/admin': () => import('../components/AdminDashboard'),
    '/user-fund-position': () => import('../components/UserFundPosition')
  };
  
  const loader = routeMap[routePath];
  if (loader) {
    loader();
  }
};

// åœ¨ç”¨æˆ·å¯èƒ½è®¿é—®çš„è·¯ç”±ä¸Šé¢„åŠ è½½
<Link 
  to="/admin" 
  onMouseEnter={() => preloadRoute('/admin')}
>
  ç®¡ç†åå°
</Link>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] è·¯ç”±çº§ä»£ç åˆ†å‰²å®Œæˆ
- [ ] é¦–å±åŠ è½½æ—¶é—´å‡å°‘ 30% ä»¥ä¸Š
- [ ] æŒ‰éœ€åŠ è½½æ­£å¸¸å·¥ä½œ
- [ ] åŠ è½½çŠ¶æ€å‹å¥½å±•ç¤º

---

### 2.4 å·¥ç¨‹åŒ–å®Œå–„æ–¹æ¡ˆ

#### 2.4.1 ä»£ç è§„èŒƒé…ç½®
**ç›®æ ‡**: ç»Ÿä¸€ä»£ç é£æ ¼ï¼Œæå‡ä»£ç è´¨é‡

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**
```bash
npm install --save-dev eslint prettier eslint-config-prettier eslint-plugin-react eslint-plugin-react-hooks
```

**æ­¥éª¤ 2: åˆ›å»ºé…ç½®æ–‡ä»¶**
```javascript
// .eslintrc.js
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true,
    jest: true
  },
  extends: [
    'eslint:recommended',
    'plugin:react/recommended',
    'plugin:react-hooks/recommended',
    'prettier'
  ],
  parserOptions: {
    ecmaFeatures: {
      jsx: true
    },
    ecmaVersion: 12,
    sourceType: 'module'
  },
  plugins: ['react', 'react-hooks'],
  rules: {
    'no-console': ['warn', { allow: ['warn', 'error'] }],
    'no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
    'react/prop-types': 'off',
    'react/react-in-jsx-scope': 'off'
  },
  settings: {
    react: {
      version: 'detect'
    }
  }
};

// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}

// .editorconfig
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false
```

**æ­¥éª¤ 3: æ·»åŠ è„šæœ¬**
```json
// package.json
{
  "scripts": {
    "lint": "eslint src server --ext .js,.jsx",
    "lint:fix": "eslint src server --ext .js,.jsx --fix",
    "format": "prettier --write \"src/**/*.{js,jsx,css}\" \"server/**/*.js\"",
    "format:check": "prettier --check \"src/**/*.{js,jsx,css}\" \"server/**/*.js\""
  }
}
```

**æ­¥éª¤ 4: é…ç½® Git Hooks**
```bash
npm install --save-dev husky lint-staged

npx husky install
npx husky add .husky/pre-commit "npx lint-staged"
```

```json
// package.json
{
  "lint-staged": {
    "*.{js,jsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.css": [
      "prettier --write"
    ]
  }
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ESLint é…ç½®ç”Ÿæ•ˆ
- [ ] Prettier é…ç½®ç”Ÿæ•ˆ
- [ ] Git Hooks æ­£å¸¸å·¥ä½œ
- [ ] ä»£ç é£æ ¼ç»Ÿä¸€

---

#### 2.4.2 æµ‹è¯•ä½“ç³»å»ºè®¾
**ç›®æ ‡**: å»ºç«‹å®Œæ•´çš„æµ‹è¯•ä½“ç³»ï¼Œè¾¾åˆ° 80% è¦†ç›–ç‡

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: å•å…ƒæµ‹è¯•**
```javascript
// server/tests/unit/authService.test.js
const authService = require('../../services/authService');
const userDao = require('../../dao/userDao');
const PasswordHelper = require('../../utils/passwordHelper');

jest.mock('../../dao/userDao');
jest.mock('../../utils/passwordHelper');

describe('AuthService', () => {
  describe('login', () => {
    it('should return tokens when credentials are valid', async () => {
      const mockUser = {
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
        password: 'hashedPassword',
        role: 'user'
      };
      
      userDao.findByEmail.mockResolvedValue(mockUser);
      PasswordHelper.verify.mockResolvedValue(true);
      
      const result = await authService.login('test@example.com', 'password');
      
      expect(result).toHaveProperty('accessToken');
      expect(result).toHaveProperty('refreshToken');
      expect(result.user.email).toBe('test@example.com');
    });
    
    it('should throw error when user not found', async () => {
      userDao.findByEmail.mockResolvedValue(null);
      
      await expect(
        authService.login('nonexistent@example.com', 'password')
      ).rejects.toThrow('ç”¨æˆ·ä¸å­˜åœ¨');
    });
    
    it('should throw error when password is invalid', async () => {
      const mockUser = {
        id: 1,
        email: 'test@example.com',
        password: 'hashedPassword'
      };
      
      userDao.findByEmail.mockResolvedValue(mockUser);
      PasswordHelper.verify.mockResolvedValue(false);
      
      await expect(
        authService.login('test@example.com', 'wrongpassword')
      ).rejects.toThrow('å¯†ç é”™è¯¯');
    });
  });
});

// src/hooks/useApi.test.js
import { renderHook, act } from '@testing-library/react-hooks';
import useApi from './useApi';

describe('useApi', () => {
  it('should handle successful API call', async () => {
    const mockApiFunc = jest.fn().mockResolvedValue({ data: 'test' });
    const { result } = renderHook(() => useApi(mockApiFunc));
    
    await act(async () => {
      await result.current.execute();
    });
    
    expect(result.current.data).toEqual({ data: 'test' });
    expect(result.current.loading).toBe(false);
    expect(result.current.error).toBe(null);
  });
  
  it('should handle API error', async () => {
    const mockApiFunc = jest.fn().mockRejectedValue(new Error('API Error'));
    const { result } = renderHook(() => useApi(mockApiFunc));
    
    await act(async () => {
      try {
        await result.current.execute();
      } catch (e) {
        // Expected error
      }
    });
    
    expect(result.current.error).toBe('API Error');
    expect(result.current.loading).toBe(false);
  });
});
```

**æ­¥éª¤ 2: é›†æˆæµ‹è¯•**
```javascript
// server/tests/integration/auth.test.js
const request = require('supertest');
const app = require('../../server');
const db = require('../../utils/database');

describe('Auth API Integration Tests', () => {
  beforeAll(async () => {
    // åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
    await db.run('DELETE FROM users');
  });
  
  afterAll(async () => {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    await db.run('DELETE FROM users');
  });
  
  describe('POST /api/auth/register', () => {
    it('should register a new user', async () => {
      const response = await request(app)
        .post('/api/auth/register')
        .send({
          name: 'Test User',
          email: 'test@example.com',
          password: 'password123',
          role: 'user'
        });
      
      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body).toHaveProperty('userId');
    });
    
    it('should not register duplicate email', async () => {
      const response = await request(app)
        .post('/api/auth/register')
        .send({
          name: 'Test User 2',
          email: 'test@example.com',
          password: 'password123',
          role: 'user'
        });
      
      expect(response.status).toBe(400);
      expect(response.body.error).toContain('é‚®ç®±å·²è¢«æ³¨å†Œ');
    });
  });
  
  describe('POST /api/auth/login', () => {
    it('should login with valid credentials', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123'
        });
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.headers['set-cookie']).toBeDefined();
    });
    
    it('should not login with invalid password', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'wrongpassword'
        });
      
      expect(response.status).toBe(401);
    });
  });
});
```

**æ­¥éª¤ 3: E2E æµ‹è¯•**
```javascript
// tests/cypress/e2e/auth.cy.js
describe('Authentication Flow', () => {
  beforeEach(() => {
    cy.visit('http://localhost:8085');
  });
  
  it('should login successfully', () => {
    cy.get('input[name="email"]').type('admin@example.com');
    cy.get('input[name="password"]').type('admin');
    cy.get('button[type="submit"]').click();
    
    cy.url().should('include', '/admin');
    cy.contains('ç®¡ç†åå°').should('be.visible');
  });
  
  it('should show error with invalid credentials', () => {
    cy.get('input[name="email"]').type('admin@example.com');
    cy.get('input[name="password"]').type('wrongpassword');
    cy.get('button[type="submit"]').click();
    
    cy.contains('å¯†ç é”™è¯¯').should('be.visible');
  });
  
  it('should logout successfully', () => {
    // Login first
    cy.get('input[name="email"]').type('admin@example.com');
    cy.get('input[name="password"]').type('admin');
    cy.get('button[type="submit"]').click();
    
    // Logout
    cy.get('[data-testid="logout-button"]').click();
    cy.url().should('include', '/login');
  });
});
```

**æ­¥éª¤ 4: é…ç½®è¦†ç›–ç‡**
```json
// jest.config.js
module.exports = {
  collectCoverageFrom: [
    'src/**/*.{js,jsx}',
    'server/**/*.js',
    '!src/index.js',
    '!server/server.js',
    '!**/node_modules/**',
    '!**/tests/**'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒæµç¨‹
- [ ] E2E æµ‹è¯•è¦†ç›–ä¸»è¦ç”¨æˆ·åœºæ™¯
- [ ] CI ä¸­è‡ªåŠ¨è¿è¡Œæµ‹è¯•

---

#### 2.4.3 CI/CD ä¼˜åŒ–
**ç›®æ ‡**: å®Œå–„ CI/CD æµç¨‹ï¼Œå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: ä¼˜åŒ– CI é…ç½®**
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run format:check
  
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
  
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm audit --audit-level=high
  
  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: build/
```

**æ­¥éª¤ 2: æ·»åŠ  CD é…ç½®**
```yaml
# .github/workflows/cd.yml
name: CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            yourusername/trading-custody:latest
            yourusername/trading-custody:${{ github.sha }}
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/trading-custody
            docker-compose pull
            docker-compose up -d
            docker-compose exec -T app npm run migrate
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] CI æµç¨‹åŒ…å« lintã€testã€securityã€build
- [ ] CD æµç¨‹è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šè‡ªåŠ¨ä¸Šä¼ 
- [ ] éƒ¨ç½²å¤±è´¥è‡ªåŠ¨å›æ»š

---

#### 2.4.4 ç¯å¢ƒå˜é‡ç®¡ç†
**ç›®æ ‡**: è§„èŒƒç¯å¢ƒå˜é‡é…ç½®

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤ 1: åˆ›å»ºç¯å¢ƒå˜é‡ç¤ºä¾‹**
```bash
# .env.example

# åº”ç”¨é…ç½®
NODE_ENV=development
APP_PORT=8085
SERVER_PORT=3001

# æ•°æ®åº“é…ç½®
DATABASE_PATH=./server/database.db

# JWT é…ç½®
JWT_ACCESS_SECRET=è¯·ç”Ÿæˆä¸€ä¸ªå¼ºéšæœºå¯†é’¥
JWT_REFRESH_SECRET=è¯·ç”Ÿæˆå¦ä¸€ä¸ªå¼ºéšæœºå¯†é’¥
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# CORS é…ç½®
CORS_ORIGIN=http://localhost:8085

# å¤–éƒ¨ API
STOCK_API_URL=http://23.95.205.223:18201/api/public/stock_zh_a_hist
FUTURE_API_URL=http://23.95.205.223:18201/api/public/futures_hist_em

# å®šæ—¶ä»»åŠ¡
PRICE_SYNC_CRON=0 17 * * *

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FILE_PATH=./logs/app.log

# å‰ç«¯ API åœ°å€
REACT_APP_API_BASE_URL=http://localhost:3001
```

**æ­¥éª¤ 2: åˆ›å»ºç¯å¢ƒå˜é‡åŠ è½½å·¥å…·**
```javascript
// server/config/env.js
require('dotenv').config();

const config = {
  env: process.env.NODE_ENV || 'development',
  port: parseInt(process.env.SERVER_PORT) || 3001,
  
  database: {
    path: process.env.DATABASE_PATH || './server/database.db'
  },
  
  jwt: {
    accessSecret: process.env.JWT_ACCESS_SECRET,
    refreshSecret: process.env.JWT_REFRESH_SECRET,
    accessExpiresIn: process.env.JWT_ACCESS_EXPIRES_IN || '15m',
    refreshExpiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d'
  },
  
  cors: {
    origin: process.env.CORS_ORIGIN || '*',
    credentials: true
  },
  
  externalApis: {
    stock: process.env.STOCK_API_URL,
    future: process.env.FUTURE_API_URL
  },
  
  cron: {
    priceSync: process.env.PRICE_SYNC_CRON || '0 17 * * *'
  },
  
  log: {
    level: process.env.LOG_LEVEL || 'info',
    filePath: process.env.LOG_FILE_PATH || './logs/app.log'
  }
};

// éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
const requiredEnvVars = ['JWT_ACCESS_SECRET', 'JWT_REFRESH_SECRET'];
const missingEnvVars = requiredEnvVars.filter(key => !process.env[key]);

if (missingEnvVars.length > 0) {
  throw new Error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missingEnvVars.join(', ')}`);
}

module.exports = config;
```

**æ­¥éª¤ 3: ç”Ÿæˆå¯†é’¥è„šæœ¬**
```javascript
// scripts/generate-secrets.js
const crypto = require('crypto');

const generateSecret = () => {
  return crypto.randomBytes(64).toString('hex');
};

console.log('ç”Ÿæˆçš„ JWT å¯†é’¥ï¼š\n');
console.log(`JWT_ACCESS_SECRET=${generateSecret()}`);
console.log(`JWT_REFRESH_SECRET=${generateSecret()}`);
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] .env.example æ–‡ä»¶å®Œæ•´
- [ ] ç¯å¢ƒå˜é‡éªŒè¯æœºåˆ¶ç”Ÿæ•ˆ
- [ ] æ‰€æœ‰é…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
- [ ] å¯†é’¥ç”Ÿæˆè„šæœ¬å¯ç”¨

---

## ä¸‰ã€ä»»åŠ¡æ‰§è¡Œè®¡åˆ’

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨åŠ å›ºï¼ˆ1-2 å¤©ï¼‰

#### ä»»åŠ¡ 1.1: å¯†ç åŠ å¯†æ”¹é€ 
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P0
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å®‰è£… bcrypt ä¾èµ–
  - [ ] åˆ›å»º PasswordHelper å·¥å…·ç±»
  - [ ] ä¿®æ”¹ç”¨æˆ·æ³¨å†Œé€»è¾‘
  - [ ] ä¿®æ”¹ç™»å½•éªŒè¯é€»è¾‘
  - [ ] ä¿®æ”¹å¯†ç ä¿®æ”¹é€»è¾‘
  - [ ] ç¼–å†™å¯†ç è¿ç§»è„šæœ¬
  - [ ] æ‰§è¡Œæ•°æ®è¿ç§»
  - [ ] æµ‹è¯•æ‰€æœ‰è®¤è¯åŠŸèƒ½

#### ä»»åŠ¡ 1.2: JWT å®‰å…¨æ”¹é€ 
- **è´Ÿè´£äºº**: å…¨æ ˆå¼€å‘
- **å·¥æ—¶**: 6 å°æ—¶
- **ä¼˜å…ˆçº§**: P0
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å®‰è£… cookie-parser ä¾èµ–
  - [ ] é…ç½® JWT ç¯å¢ƒå˜é‡
  - [ ] åˆ›å»º JwtHelper å·¥å…·ç±»
  - [ ] ä¿®æ”¹ç™»å½•æ¥å£è¿”å› Cookie
  - [ ] åˆ›å»º token åˆ·æ–°æ¥å£
  - [ ] ä¿®æ”¹è®¤è¯ä¸­é—´ä»¶è¯»å– Cookie
  - [ ] ä¿®æ”¹å‰ç«¯ API è°ƒç”¨æºå¸¦ Cookie
  - [ ] ç§»é™¤ localStorage ç›¸å…³ä»£ç 
  - [ ] æ·»åŠ  CSRF ä¿æŠ¤
  - [ ] æµ‹è¯•è®¤è¯æµç¨‹

#### ä»»åŠ¡ 1.3: API æƒé™æ§åˆ¶
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P0
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å¢å¼ºè®¤è¯ä¸­é—´ä»¶
  - [ ] åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
  - [ ] åˆ›å»ºèµ„æºæ‰€æœ‰æƒéªŒè¯ä¸­é—´ä»¶
  - [ ] ä¸ºæ‰€æœ‰æ•æ„Ÿæ¥å£æ·»åŠ ä¸­é—´ä»¶
  - [ ] æµ‹è¯•æƒé™æ§åˆ¶

#### ä»»åŠ¡ 1.4: ä¾èµ–å®‰å…¨ä¿®å¤
- **è´Ÿè´£äºº**: DevOps
- **å·¥æ—¶**: 2 å°æ—¶
- **ä¼˜å…ˆçº§**: P0
- **ä»»åŠ¡æ¸…å•**:
  - [ ] è¿è¡Œ npm audit fix
  - [ ] æ‰‹åŠ¨æ›´æ–°æ— æ³•è‡ªåŠ¨ä¿®å¤çš„ä¾èµ–
  - [ ] æµ‹è¯•åº”ç”¨åŠŸèƒ½
  - [ ] æ›´æ–° package-lock.json

**é˜¶æ®µéªŒæ”¶**:
- [ ] æ‰€æœ‰å¯†ç å·²åŠ å¯†å­˜å‚¨
- [ ] JWT token å­˜å‚¨åœ¨ HttpOnly Cookie
- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£æœ‰æƒé™æ§åˆ¶
- [ ] ä¾èµ–å®‰å…¨æ¼æ´å·²ä¿®å¤
- [ ] å®‰å…¨æµ‹è¯•é€šè¿‡

---

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„é‡æ„ï¼ˆ1 å‘¨ï¼‰

#### ä»»åŠ¡ 2.1: æ•°æ®åº“å·¥å…·å°è£…
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º Database ç±»
  - [ ] å®ç° Promise å°è£…
  - [ ] å®ç°äº‹åŠ¡æ”¯æŒ
  - [ ] æµ‹è¯•æ•°æ®åº“å·¥å…·

#### ä»»åŠ¡ 2.2: DAO å±‚åˆ›å»º
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 8 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º UserDao
  - [ ] åˆ›å»º FundDao
  - [ ] åˆ›å»º PositionDao
  - [ ] åˆ›å»º PriceDao
  - [ ] ç¼–å†™ DAO å•å…ƒæµ‹è¯•

#### ä»»åŠ¡ 2.3: Service å±‚é‡æ„
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 12 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º AuthService
  - [ ] é‡æ„ UserService
  - [ ] é‡æ„ FundService
  - [ ] é‡æ„ PositionService
  - [ ] åˆ›å»º PriceServiceï¼ˆä» server.js è¿ç§»ï¼‰
  - [ ] ç¼–å†™ Service å•å…ƒæµ‹è¯•

#### ä»»åŠ¡ 2.4: Controller å±‚ç®€åŒ–
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 8 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º AuthController
  - [ ] ç®€åŒ– UserController
  - [ ] ç®€åŒ– FundController
  - [ ] ç®€åŒ– PositionController
  - [ ] ç¼–å†™ Controller é›†æˆæµ‹è¯•

#### ä»»åŠ¡ 2.5: server.js é‡æ„
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º config/routes.js
  - [ ] åˆ›å»º config/database.js
  - [ ] ç®€åŒ– server.js
  - [ ] æµ‹è¯•åº”ç”¨å¯åŠ¨

#### ä»»åŠ¡ 2.6: æ•°æ®åº“ä¼˜åŒ–
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 6 å°æ—¶
- **ä¼˜å…ˆçº§**: P1
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»ºè¿ç§»å·¥å…·
  - [ ] åˆ›å»ºç´¢å¼•è¿ç§»è„šæœ¬
  - [ ] ä¼˜åŒ–è¡¨ç»“æ„
  - [ ] æ‰§è¡Œè¿ç§»
  - [ ] æ€§èƒ½æµ‹è¯•

**é˜¶æ®µéªŒæ”¶**:
- [ ] ä¸‰å±‚æ¶æ„æ¸…æ™°åˆ†ç¦»
- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ async/await
- [ ] ä»£ç å¯ç»´æŠ¤æ€§æ˜¾è‘—æå‡
- [ ] æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 60%

---

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ä¼˜åŒ–ï¼ˆ3-4 å¤©ï¼‰

#### ä»»åŠ¡ 3.1: ç»„ä»¶é‡æ„
- **è´Ÿè´£äºº**: å‰ç«¯å¼€å‘
- **å·¥æ—¶**: 6 å°æ—¶
- **ä¼˜å…ˆçº§**: P2
- **ä»»åŠ¡æ¸…å•**:
  - [ ] ç§»é™¤ UserDashboard ç»„ä»¶
  - [ ] åˆ›å»º NavigationCard å…¬å…±ç»„ä»¶
  - [ ] é‡æ„ AdminDashboard
  - [ ] ç»Ÿä¸€æ ·å¼ç®¡ç†
  - [ ] æµ‹è¯•ç»„ä»¶åŠŸèƒ½

#### ä»»åŠ¡ 3.2: API è°ƒç”¨ä¼˜åŒ–
- **è´Ÿè´£äºº**: å‰ç«¯å¼€å‘
- **å·¥æ—¶**: 8 å°æ—¶
- **ä¼˜å…ˆçº§**: P2
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º ApiClient ç±»
  - [ ] é‡æ„æ‰€æœ‰ API æ–‡ä»¶
  - [ ] åˆ›å»º useApi Hook
  - [ ] æ›´æ–°ç»„ä»¶ä½¿ç”¨æ–° API
  - [ ] æµ‹è¯• API è°ƒç”¨

#### ä»»åŠ¡ 3.3: æ€§èƒ½ä¼˜åŒ–
- **è´Ÿè´£äºº**: å‰ç«¯å¼€å‘
- **å·¥æ—¶**: 6 å°æ—¶
- **ä¼˜å…ˆçº§**: P2
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å®ç°è·¯ç”±çº§ä»£ç åˆ†å‰²
  - [ ] å®ç°ç»„ä»¶çº§æ‡’åŠ è½½
  - [ ] æ·»åŠ èµ„æºé¢„åŠ è½½
  - [ ] æ€§èƒ½æµ‹è¯•
  - [ ] ä¼˜åŒ–é¦–å±åŠ è½½æ—¶é—´

**é˜¶æ®µéªŒæ”¶**:
- [ ] ç»„ä»¶ç»“æ„æ¸…æ™°
- [ ] API è°ƒç”¨ç»Ÿä¸€ç®¡ç†
- [ ] é¦–å±åŠ è½½æ—¶é—´å‡å°‘ 30%
- [ ] æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

### 3.4 ç¬¬å››é˜¶æ®µï¼šå·¥ç¨‹åŒ–å®Œå–„ï¼ˆ3-4 å¤©ï¼‰

#### ä»»åŠ¡ 4.1: ä»£ç è§„èŒƒé…ç½®
- **è´Ÿè´£äºº**: æŠ€æœ¯è´Ÿè´£äºº
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P3
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å®‰è£… ESLint å’Œ Prettier
  - [ ] åˆ›å»ºé…ç½®æ–‡ä»¶
  - [ ] é…ç½® Git Hooks
  - [ ] ä¿®å¤ç°æœ‰ä»£ç è§„èŒƒé—®é¢˜
  - [ ] æ›´æ–°æ–‡æ¡£

#### ä»»åŠ¡ 4.2: æµ‹è¯•ä½“ç³»å»ºè®¾
- **è´Ÿè´£äºº**: å…¨æ ˆå¼€å‘ + QA
- **å·¥æ—¶**: 16 å°æ—¶
- **ä¼˜å…ˆçº§**: P3
- **ä»»åŠ¡æ¸…å•**:
  - [ ] ç¼–å†™åç«¯å•å…ƒæµ‹è¯•
  - [ ] ç¼–å†™å‰ç«¯å•å…ƒæµ‹è¯•
  - [ ] ç¼–å†™é›†æˆæµ‹è¯•
  - [ ] ç¼–å†™ E2E æµ‹è¯•
  - [ ] é…ç½®è¦†ç›–ç‡æ£€æŸ¥
  - [ ] è¾¾åˆ° 80% è¦†ç›–ç‡

#### ä»»åŠ¡ 4.3: CI/CD ä¼˜åŒ–
- **è´Ÿè´£äºº**: DevOps
- **å·¥æ—¶**: 6 å°æ—¶
- **ä¼˜å…ˆçº§**: P3
- **ä»»åŠ¡æ¸…å•**:
  - [ ] ä¼˜åŒ– CI é…ç½®
  - [ ] æ·»åŠ  CD é…ç½®
  - [ ] é…ç½®è‡ªåŠ¨éƒ¨ç½²
  - [ ] æµ‹è¯• CI/CD æµç¨‹

#### ä»»åŠ¡ 4.4: ç¯å¢ƒå˜é‡ç®¡ç†
- **è´Ÿè´£äºº**: åç«¯å¼€å‘
- **å·¥æ—¶**: 3 å°æ—¶
- **ä¼˜å…ˆçº§**: P3
- **ä»»åŠ¡æ¸…å•**:
  - [ ] åˆ›å»º .env.example
  - [ ] åˆ›å»ºç¯å¢ƒå˜é‡åŠ è½½å·¥å…·
  - [ ] åˆ›å»ºå¯†é’¥ç”Ÿæˆè„šæœ¬
  - [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£

#### ä»»åŠ¡ 4.5: Docker ä¼˜åŒ–
- **è´Ÿè´£äºº**: DevOps
- **å·¥æ—¶**: 4 å°æ—¶
- **ä¼˜å…ˆçº§**: P3
- **ä»»åŠ¡æ¸…å•**:
  - [ ] å‡çº§ Node.js ç‰ˆæœ¬åˆ° 18
  - [ ] æ·»åŠ  .dockerignore
  - [ ] ä¼˜åŒ– Dockerfile
  - [ ] æµ‹è¯• Docker éƒ¨ç½²

**é˜¶æ®µéªŒæ”¶**:
- [ ] ä»£ç è§„èŒƒç»Ÿä¸€
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] CI/CD æµç¨‹å®Œå–„
- [ ] ç¯å¢ƒå˜é‡è§„èŒƒç®¡ç†
- [ ] Docker é…ç½®ä¼˜åŒ–

---

### 3.5 ç¬¬äº”é˜¶æ®µï¼šæ–‡æ¡£å’ŒåŸ¹è®­ï¼ˆ1-2 å¤©ï¼‰

#### ä»»åŠ¡ 5.1: æŠ€æœ¯æ–‡æ¡£æ›´æ–°
- **è´Ÿè´£äºº**: æŠ€æœ¯è´Ÿè´£äºº
- **å·¥æ—¶**: 4 å°æ—¶
- **ä»»åŠ¡æ¸…å•**:
  - [ ] æ›´æ–°æ¶æ„æ–‡æ¡£
  - [ ] æ›´æ–° API æ–‡æ¡£
  - [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£
  - [ ] æ›´æ–°å¼€å‘æŒ‡å—

#### ä»»åŠ¡ 5.2: å›¢é˜ŸåŸ¹è®­
- **è´Ÿè´£äºº**: æŠ€æœ¯è´Ÿè´£äºº
- **å·¥æ—¶**: 4 å°æ—¶
- **ä»»åŠ¡æ¸…å•**:
  - [ ] æ–°æ¶æ„åŸ¹è®­
  - [ ] å®‰å…¨è§„èŒƒåŸ¹è®­
  - [ ] ä»£ç è§„èŒƒåŸ¹è®­
  - [ ] æµ‹è¯•è§„èŒƒåŸ¹è®­

**é˜¶æ®µéªŒæ”¶**:
- [ ] æ–‡æ¡£å®Œæ•´æ›´æ–°
- [ ] å›¢é˜ŸåŸ¹è®­å®Œæˆ
- [ ] çŸ¥è¯†è½¬ç§»å®Œæˆ

---

## å››ã€é£é™©è¯„ä¼°ä¸åº”å¯¹

### 4.1 æŠ€æœ¯é£é™©

#### é£é™© 1: æ•°æ®è¿ç§»å¤±è´¥
- **æ¦‚ç‡**: ä¸­
- **å½±å“**: é«˜
- **åº”å¯¹æªæ–½**:
  - åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯•è¿ç§»è„šæœ¬
  - ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰å®Œæ•´å¤‡ä»½æ•°æ®åº“
  - å‡†å¤‡å›æ»šæ–¹æ¡ˆ
  - åˆ†æ­¥éª¤æ‰§è¡Œï¼Œæ¯æ­¥éªŒè¯

#### é£é™© 2: é‡æ„å¼•å…¥æ–° Bug
- **æ¦‚ç‡**: é«˜
- **å½±å“**: ä¸­
- **åº”å¯¹æªæ–½**:
  - å…ˆç¼–å†™æµ‹è¯•ç”¨ä¾‹å†é‡æ„
  - å°æ­¥å¿«è·‘ï¼Œé¢‘ç¹æµ‹è¯•
  - ä½¿ç”¨ feature flag æ§åˆ¶æ–°åŠŸèƒ½å‘å¸ƒ
  - ä¿ç•™æ—§ä»£ç ä½œä¸ºå¤‡ä»½

#### é£é™© 3: æ€§èƒ½ä¸‹é™
- **æ¦‚ç‡**: ä½
- **å½±å“**: ä¸­
- **åº”å¯¹æªæ–½**:
  - é‡æ„å‰åè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
  - ç›‘æ§å…³é”®æŒ‡æ ‡
  - å‡†å¤‡æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 4.2 é¡¹ç›®é£é™©

#### é£é™© 4: å·¥æœŸå»¶è¯¯
- **æ¦‚ç‡**: ä¸­
- **å½±å“**: ä¸­
- **åº”å¯¹æªæ–½**:
  - æŒ‰ä¼˜å…ˆçº§åˆ†é˜¶æ®µå®æ–½
  - P0 ä»»åŠ¡å¿…é¡»å®Œæˆï¼ŒP3 ä»»åŠ¡å¯å»¶å
  - æ¯æ—¥ç«™ä¼šè·Ÿè¸ªè¿›åº¦
  - åŠæ—¶è°ƒæ•´èµ„æº

#### é£é™© 5: äººå‘˜ä¸è¶³
- **æ¦‚ç‡**: ä½
- **å½±å“**: é«˜
- **åº”å¯¹æªæ–½**:
  - æå‰è¯„ä¼°äººåŠ›éœ€æ±‚
  - å…³é”®ä»»åŠ¡å®‰æ’ç»éªŒä¸°å¯Œçš„å¼€å‘è€…
  - å‡†å¤‡å¤–éƒ¨æ”¯æŒæ–¹æ¡ˆ

### 4.3 ä¸šåŠ¡é£é™©

#### é£é™© 6: å½±å“çº¿ä¸ŠæœåŠ¡
- **æ¦‚ç‡**: ä½
- **å½±å“**: é«˜
- **åº”å¯¹æªæ–½**:
  - åœ¨éä¸šåŠ¡é«˜å³°æœŸéƒ¨ç½²
  - ç°åº¦å‘å¸ƒï¼Œé€æ­¥åˆ‡é‡
  - å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ
  - 24 å°æ—¶ç›‘æ§

---

## äº”ã€èµ„æºéœ€æ±‚

### 5.1 äººåŠ›èµ„æº
- **åç«¯å¼€å‘**: 1 äººï¼Œå…¨èŒ 2 å‘¨
- **å‰ç«¯å¼€å‘**: 1 äººï¼Œå…¨èŒ 1 å‘¨
- **å…¨æ ˆå¼€å‘**: 1 äººï¼Œå…¨èŒ 1 å‘¨
- **DevOps**: 0.5 äººï¼Œå…¼èŒ 1 å‘¨
- **QA**: 0.5 äººï¼Œå…¼èŒ 1 å‘¨
- **æŠ€æœ¯è´Ÿè´£äºº**: 0.5 äººï¼Œå…¨ç¨‹å‚ä¸

### 5.2 æ—¶é—´èµ„æº
- **æ€»å·¥æœŸ**: 3-4 å‘¨
- **ç¬¬ä¸€é˜¶æ®µ**: 1-2 å¤©ï¼ˆå®‰å…¨åŠ å›ºï¼‰
- **ç¬¬äºŒé˜¶æ®µ**: 1 å‘¨ï¼ˆæ¶æ„é‡æ„ï¼‰
- **ç¬¬ä¸‰é˜¶æ®µ**: 3-4 å¤©ï¼ˆå‰ç«¯ä¼˜åŒ–ï¼‰
- **ç¬¬å››é˜¶æ®µ**: 3-4 å¤©ï¼ˆå·¥ç¨‹åŒ–å®Œå–„ï¼‰
- **ç¬¬äº”é˜¶æ®µ**: 1-2 å¤©ï¼ˆæ–‡æ¡£å’ŒåŸ¹è®­ï¼‰

### 5.3 æŠ€æœ¯èµ„æº
- **å¼€å‘ç¯å¢ƒ**: æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **æµ‹è¯•ç¯å¢ƒ**: ç‹¬ç«‹æµ‹è¯•æœåŠ¡å™¨
- **ç”Ÿäº§ç¯å¢ƒ**: ç”Ÿäº§æœåŠ¡å™¨
- **CI/CD**: GitHub Actions
- **ç›‘æ§**: æ—¥å¿—ç³»ç»Ÿ + æ€§èƒ½ç›‘æ§

---

## å…­ã€éªŒæ”¶æ ‡å‡†

### 6.1 å®‰å…¨æ€§éªŒæ”¶
- [ ] å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- [ ] JWT token å­˜å‚¨åœ¨ HttpOnly Cookie
- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£æœ‰è®¤è¯å’Œæƒé™æ§åˆ¶
- [ ] ä¾èµ–åŒ…æ— é«˜å±å®‰å…¨æ¼æ´
- [ ] é€šè¿‡å®‰å…¨æ‰«ææµ‹è¯•

### 6.2 æ¶æ„éªŒæ”¶
- [ ] ä¸‰å±‚æ¶æ„æ¸…æ™°åˆ†ç¦»
- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ async/await
- [ ] ä»£ç å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§æ˜¾è‘—æå‡
- [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æå‡ 50% ä»¥ä¸Š

### 6.3 ä»£ç è´¨é‡éªŒæ”¶
- [ ] ä»£ç ç¬¦åˆ ESLint è§„èŒƒ
- [ ] ä»£ç æ ¼å¼ç¬¦åˆ Prettier è§„èŒƒ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒæµç¨‹
- [ ] E2E æµ‹è¯•è¦†ç›–ä¸»è¦ç”¨æˆ·åœºæ™¯

### 6.4 æ€§èƒ½éªŒæ”¶
- [ ] é¦–å±åŠ è½½æ—¶é—´å‡å°‘ 30% ä»¥ä¸Š
- [ ] API å“åº”æ—¶é—´ < 200ms
- [ ] æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 50ms
- [ ] å‰ç«¯åŒ…ä½“ç§¯å‡å°‘ 20% ä»¥ä¸Š

### 6.5 å·¥ç¨‹åŒ–éªŒæ”¶
- [ ] CI/CD æµç¨‹å®Œå–„
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•æ­£å¸¸è¿è¡Œ
- [ ] ä»£ç è§„èŒƒæ£€æŸ¥ç”Ÿæ•ˆ
- [ ] ç¯å¢ƒå˜é‡è§„èŒƒç®¡ç†
- [ ] Docker éƒ¨ç½²æ­£å¸¸

### 6.6 æ–‡æ¡£éªŒæ”¶
- [ ] æ¶æ„æ–‡æ¡£å®Œæ•´
- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] éƒ¨ç½²æ–‡æ¡£å®Œæ•´
- [ ] å¼€å‘æŒ‡å—å®Œæ•´
- [ ] å›¢é˜ŸåŸ¹è®­å®Œæˆ

---

## ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2 ä¸ªæœˆï¼‰
1. **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ**: æ¥å…¥ APM å·¥å…·ï¼Œå®æ—¶ç›‘æ§åº”ç”¨æ€§èƒ½
2. **æ—¥å¿—åˆ†æç³»ç»Ÿ**: é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
3. **ç¼“å­˜æœºåˆ¶**: å¼•å…¥ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
4. **API é™æµ**: é˜²æ­¢æ¥å£è¢«æ¶æ„è°ƒç”¨

### 7.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6 ä¸ªæœˆï¼‰
1. **å¾®æœåŠ¡æ‹†åˆ†**: å°†å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºå¾®æœåŠ¡æ¶æ„
2. **æ¶ˆæ¯é˜Ÿåˆ—**: å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡
3. **æ•°æ®åº“å‡çº§**: è€ƒè™‘è¿ç§»åˆ° PostgreSQL æˆ– MySQL
4. **CDN åŠ é€Ÿ**: é™æ€èµ„æºä½¿ç”¨ CDN åŠ é€Ÿ

### 7.3 é•¿æœŸä¼˜åŒ–ï¼ˆ6-12 ä¸ªæœˆï¼‰
1. **å®¹å™¨ç¼–æ’**: ä½¿ç”¨ Kubernetes è¿›è¡Œå®¹å™¨ç¼–æ’
2. **æœåŠ¡ç½‘æ ¼**: å¼•å…¥ Service Mesh ç®¡ç†å¾®æœåŠ¡
3. **å¤§æ•°æ®åˆ†æ**: å»ºç«‹æ•°æ®åˆ†æå¹³å°
4. **AI èƒ½åŠ›**: å¼•å…¥ AI èƒ½åŠ›æå‡ç”¨æˆ·ä½“éªŒ

---

## å…«ã€é™„å½•

### 8.1 ç›¸å…³æ–‡æ¡£
- [æŠ€æœ¯æ¶æ„åˆ†ææŠ¥å‘Š](./æŠ€æœ¯æ¶æ„åˆ†ææŠ¥å‘Š.md)
- [API æ–‡æ¡£](./docs/api.md)
- [éƒ¨ç½²æ–‡æ¡£](./docs/deployment.md)
- [ç¯å¢ƒå˜é‡æ–‡æ¡£](./docs/ENVIRONMENT_VARIABLES.md)

### 8.2 å‚è€ƒèµ„æ–™
- [Node.js æœ€ä½³å®è·µ](https://github.com/goldbergyoni/nodebestpractices)
- [React æœ€ä½³å®è·µ](https://react.dev/learn)
- [JWT æœ€ä½³å®è·µ](https://tools.ietf.org/html/rfc8725)
- [OWASP å®‰å…¨æŒ‡å—](https://owasp.org/www-project-top-ten/)

### 8.3 è”ç³»æ–¹å¼
- **æŠ€æœ¯è´Ÿè´£äºº**: [å§“å] - [é‚®ç®±]
- **é¡¹ç›®ç»ç†**: [å§“å] - [é‚®ç®±]
- **æŠ€æœ¯æ”¯æŒ**: [å›¢é˜Ÿé‚®ç®±]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-19  
**ä¸‹æ¬¡è¯„å®¡**: 2025-12-26

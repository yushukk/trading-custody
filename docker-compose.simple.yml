version: '3.8'

# ==========================================
# Trading Custody - 简化部署配置
# ==========================================
# 适用于飞牛等容器平台，无需任何脚本，开箱即用
# 
# 使用方法：
#   1. 直接上传此文件到容器平台（无需修改任何配置）
#   2. 点击部署即可
#   3. 系统会自动生成 JWT 密钥并启动
# ==========================================

services:
  # 后端服务
  backend:
    image: yushu/trading-custody-backend:latest
    container_name: trading-custody-backend
    restart: unless-stopped
    # ports:
    #   - "3001:3001"  
    volumes:
      - backend-data:/app/server/data
      - backend-logs:/app/logs
    environment:
      # ==========================================
      # JWT 密钥配置（可选）
      # ==========================================
      # 说明：
      #   - 默认不配置，系统会在首次启动时自动生成安全的随机密钥
      #   - 如需自定义密钥，取消下方注释并填写自己的密钥
      #   - 生产环境建议使用自定义密钥（运行 node scripts/generate-secrets.js 生成）
      # ==========================================
      
      # JWT 访问令牌密钥（可选，不配置则自动生成）
      # - JWT_ACCESS_SECRET=your-custom-access-secret-here
      
      # JWT 刷新令牌密钥（可选，不配置则自动生成）
      # - JWT_REFRESH_SECRET=your-custom-refresh-secret-here
      
      # ==========================================
      # 可选配置项（根据需要修改）
      # ==========================================
      # 运行环境
      - NODE_ENV=production
      
      # 数据库路径（容器内路径，无需修改）
      - DATABASE_PATH=/app/server/data/database.db
      
      # 服务器端口（容器内端口，无需修改）
      - SERVER_PORT=3001
      
      # JWT 令牌过期时间
      - JWT_ACCESS_EXPIRES_IN=15m
      - JWT_REFRESH_EXPIRES_IN=60d
      
      # CORS 跨域配置（* 表示允许所有来源，生产环境建议改为具体域名）
      - CORS_ORIGIN=*
      
      # 股票数据 API
      - STOCK_API_URL=http://23.95.205.223:18201/api/public/stock_zh_a_hist
      
      # 期货数据 API
      - FUTURE_API_URL=http://23.95.205.223:18201/api/public/futures_hist_em
      
      # 价格同步定时任务（每天下午 5 点）
      - PRICE_SYNC_CRON=0 17 * * *
      
      # 日志级别（debug/info/warn/error）
      - LOG_LEVEL=info
      
      # 日志文件路径（容器内路径，无需修改）
      - LOG_FILE_PATH=/app/logs/app.log
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network

  # 前端服务
  frontend:
    image: yushu/trading-custody:latest
    container_name: trading-custody-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend  # 简化依赖，不等待健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

# 数据卷（持久化存储）
volumes:
  backend-data:
    driver: local
  backend-logs:
    driver: local

# 网络配置
networks:
  app-network:
    driver: bridge
